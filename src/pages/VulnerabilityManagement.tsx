import { useState, useMemo } from "react";
import { DashboardLayout } from "@/components/DashboardLayout";
import { MetricCard } from "@/components/MetricCard";
import { FilterBar } from "@/components/FilterBar";
import { DrillDownModal } from "@/components/DrillDownModal";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { 
  Shield, 
  AlertTriangle, 
  CheckCircle2, 
  Clock,
  Bug,
  TrendingUp,
  Download,
  ExternalLink
} from "lucide-react";
import {
  BarChart,
  Bar,
  LineChart,
  Line,
  PieChart,
  Pie,
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  Cell,
} from "recharts";

const cvssDistribution = [
  { range: "9.0-10.0 (Critical)", count: 47, color: "hsl(var(--destructive))" },
  { range: "7.0-8.9 (High)", count: 128, color: "hsl(48, 96%, 53%)" },
  { range: "4.0-6.9 (Medium)", count: 256, color: "hsl(var(--primary))" },
  { range: "0.1-3.9 (Low)", count: 189, color: "hsl(var(--accent))" },
];

const patchStatus = [
  { status: "Patched", count: 412, color: "hsl(var(--accent))" },
  { status: "Patch Available", count: 156, color: "hsl(var(--primary))" },
  { status: "Workaround", count: 78, color: "hsl(48, 96%, 53%)" },
  { status: "No Patch", count: 34, color: "hsl(var(--destructive))" },
];

const cveTrends = [
  { month: "Jan", critical: 8, high: 22, medium: 45, low: 32 },
  { month: "Feb", critical: 12, high: 28, medium: 52, low: 38 },
  { month: "Mar", critical: 15, high: 35, medium: 48, low: 41 },
  { month: "Apr", critical: 10, high: 30, medium: 55, low: 35 },
  { month: "May", critical: 18, high: 38, medium: 62, low: 45 },
  { month: "Jun", critical: 14, high: 32, medium: 58, low: 39 },
];

const remediationTimeline = [
  { week: "Week 1", critical: 45, high: 82, medium: 128 },
  { week: "Week 2", critical: 38, high: 75, medium: 115 },
  { week: "Week 3", critical: 28, high: 62, medium: 98 },
  { week: "Week 4", critical: 18, high: 48, medium: 82 },
  { week: "Week 5", critical: 12, high: 35, medium: 65 },
  { week: "Week 6", critical: 5, high: 22, medium: 45 },
];

const exploitAvailability = [
  { category: "Public Exploit", count: 89, color: "hsl(var(--destructive))" },
  { category: "PoC Available", count: 134, color: "hsl(48, 96%, 53%)" },
  { category: "Exploit Predicted", count: 167, color: "hsl(var(--primary))" },
  { category: "No Known Exploit", count: 290, color: "hsl(var(--accent))" },
];

const vulnerabilities = [
  {
    id: "CVE-2024-1234",
    title: "Remote Code Execution in Apache HTTP Server",
    cvss: 9.8,
    severity: "critical",
    affectedSystems: 45,
    exploitAvailable: true,
    patchStatus: "patch-available",
    discovered: "2024-05-15",
    patchReleased: "2024-05-18",
    remediationDeadline: "2024-06-01",
    daysToRemediate: 14,
    description: "A critical vulnerability allowing unauthenticated remote code execution through improper input validation",
    affectedVersions: "2.4.0 - 2.4.58",
    vendor: "Apache",
  },
  {
    id: "CVE-2024-5678",
    title: "SQL Injection in PostgreSQL Client Library",
    cvss: 8.6,
    severity: "high",
    affectedSystems: 78,
    exploitAvailable: true,
    patchStatus: "patched",
    discovered: "2024-04-22",
    patchReleased: "2024-04-25",
    remediationDeadline: "2024-05-15",
    daysToRemediate: 0,
    description: "SQL injection vulnerability in PostgreSQL client library allowing data exfiltration",
    affectedVersions: "14.0 - 14.11",
    vendor: "PostgreSQL",
  },
  {
    id: "CVE-2024-9012",
    title: "Privilege Escalation in Linux Kernel",
    cvss: 7.8,
    severity: "high",
    affectedSystems: 234,
    exploitAvailable: false,
    patchStatus: "patch-available",
    discovered: "2024-06-01",
    patchReleased: "2024-06-05",
    remediationDeadline: "2024-06-25",
    daysToRemediate: 20,
    description: "Local privilege escalation vulnerability in Linux kernel memory management",
    affectedVersions: "5.15 - 6.8.9",
    vendor: "Linux Foundation",
  },
  {
    id: "CVE-2024-3456",
    title: "Cross-Site Scripting in React Framework",
    cvss: 6.1,
    severity: "medium",
    affectedSystems: 156,
    exploitAvailable: false,
    patchStatus: "patched",
    discovered: "2024-03-10",
    patchReleased: "2024-03-12",
    remediationDeadline: "2024-04-10",
    daysToRemediate: 0,
    description: "XSS vulnerability in React's server-side rendering component",
    affectedVersions: "18.0.0 - 18.2.0",
    vendor: "Meta",
  },
  {
    id: "CVE-2024-7890",
    title: "Denial of Service in Nginx Web Server",
    cvss: 7.5,
    severity: "high",
    affectedSystems: 89,
    exploitAvailable: true,
    patchStatus: "workaround",
    discovered: "2024-05-28",
    patchReleased: null,
    remediationDeadline: "2024-06-20",
    daysToRemediate: 23,
    description: "DoS vulnerability through malformed HTTP/2 requests causing service disruption",
    affectedVersions: "1.20.0 - 1.25.5",
    vendor: "Nginx",
  },
];

const categoryFilters = [
  { value: "all", label: "All Vulnerabilities" },
  { value: "critical", label: "Critical" },
  { value: "high", label: "High" },
  { value: "medium", label: "Medium" },
  { value: "low", label: "Low" },
];

const VulnerabilityManagement = () => {
  const [dateRange, setDateRange] = useState({ from: new Date(2024, 0, 1), to: new Date() });
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [selectedCard, setSelectedCard] = useState<string | null>(null);
  const [drillDownData, setDrillDownData] = useState<any>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);

  const handleReset = () => {
    setDateRange({ from: new Date(2024, 0, 1), to: new Date() });
    setSelectedCategory("all");
    setSelectedCard(null);
  };

  const handleCardClick = (cardId: string) => {
    setSelectedCard(selectedCard === cardId ? null : cardId);
  };

  const handleChartClick = (data: any, chartType: string) => {
    setDrillDownData({
      title: `${chartType} Details`,
      value: data.value || data.count || data.critical,
      trend: "+12%",
      period: "vs last period",
      details: Object.entries(data).map(([key, value]) => ({
        label: key.charAt(0).toUpperCase() + key.slice(1),
        value: String(value),
      })),
    });
    setIsModalOpen(true);
  };

  const getMetricMultiplier = () => {
    const days = Math.ceil((dateRange.to.getTime() - dateRange.from.getTime()) / (1000 * 60 * 60 * 24));
    return Math.max(0.5, Math.min(2, days / 180));
  };

  const multiplier = getMetricMultiplier();

  const filteredVulnerabilities = useMemo(() => {
    if (selectedCategory === "all") return vulnerabilities;
    return vulnerabilities.filter(vuln => vuln.severity === selectedCategory);
  }, [selectedCategory]);

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "critical": return "hsl(var(--destructive))";
      case "high": return "hsl(48, 96%, 53%)";
      case "medium": return "hsl(var(--primary))";
      case "low": return "hsl(var(--accent))";
      default: return "hsl(var(--muted))";
    }
  };

  const getSeverityBadgeVariant = (severity: string): "destructive" | "default" | "secondary" | "outline" => {
    switch (severity) {
      case "critical": return "destructive";
      case "high": return "default";
      case "medium": return "secondary";
      default: return "outline";
    }
  };

  const getPatchStatusBadgeVariant = (status: string): "destructive" | "default" | "secondary" | "outline" => {
    switch (status) {
      case "patched": return "outline";
      case "patch-available": return "secondary";
      case "workaround": return "default";
      default: return "destructive";
    }
  };

  const getPatchStatusLabel = (status: string) => {
    switch (status) {
      case "patched": return "PATCHED";
      case "patch-available": return "PATCH AVAILABLE";
      case "workaround": return "WORKAROUND";
      default: return "NO PATCH";
    }
  };

  return (
    <DashboardLayout>
      <div className="p-6 space-y-6 animate-fade-in">
        <div>
          <h2 className="text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
            Vulnerability Management
          </h2>
          <p className="text-muted-foreground mt-2">
            CVE tracking, patch status, and remediation timeline management
          </p>
        </div>

        <FilterBar
          dateRange={dateRange}
          onDateRangeChange={(range) => {
            if (range?.from && range?.to) {
              setDateRange({ from: range.from, to: range.to });
            }
          }}
          selectedCategory={selectedCategory}
          onCategoryChange={setSelectedCategory}
          categories={categoryFilters}
          onReset={handleReset}
        />

        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          <MetricCard
            title="Total CVEs"
            value={Math.round(680 * multiplier)}
            change="+24 this week"
            changeType="negative"
            icon={Bug}
            iconColor="text-destructive"
            onClick={() => handleCardClick("cves")}
            isSelected={selectedCard === "cves"}
          />
          <MetricCard
            title="Critical Vulnerabilities"
            value={Math.round(47 * multiplier)}
            change="-8 from last week"
            changeType="positive"
            icon={AlertTriangle}
            iconColor="text-destructive"
            onClick={() => handleCardClick("critical")}
            isSelected={selectedCard === "critical"}
          />
          <MetricCard
            title="Patch Coverage"
            value="86%"
            change="+12% improvement"
            changeType="positive"
            icon={CheckCircle2}
            iconColor="text-accent"
            onClick={() => handleCardClick("coverage")}
            isSelected={selectedCard === "coverage"}
          />
          <MetricCard
            title="Avg Remediation Time"
            value={`${Math.round(18 * multiplier)}d`}
            change="-5 days improvement"
            changeType="positive"
            icon={Clock}
            iconColor="text-primary"
            onClick={() => handleCardClick("remediation")}
            isSelected={selectedCard === "remediation"}
          />
        </div>

        <div className="grid gap-4 md:grid-cols-2">
          <Card className="animate-fade-in">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Shield className="h-5 w-5 text-primary" />
                CVSS Score Distribution
              </CardTitle>
              <CardDescription>Vulnerability severity breakdown</CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={cvssDistribution}>
                  <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                  <XAxis 
                    dataKey="range" 
                    stroke="hsl(var(--muted-foreground))"
                    angle={-15}
                    textAnchor="end"
                    height={80}
                  />
                  <YAxis stroke="hsl(var(--muted-foreground))" />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: "hsl(var(--card))", 
                      border: "1px solid hsl(var(--border))",
                      borderRadius: "8px"
                    }} 
                  />
                  <Bar 
                    dataKey="count" 
                    onClick={(data) => handleChartClick(data, "CVSS Distribution")}
                    cursor="pointer"
                  >
                    {cvssDistribution.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          <Card className="animate-fade-in">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Download className="h-5 w-5 text-accent" />
                Patch Status Overview
              </CardTitle>
              <CardDescription>Current patching status across assets</CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={patchStatus}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ status, percent }) => `${status} (${(percent * 100).toFixed(0)}%)`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="count"
                    onClick={(data) => handleChartClick(data, "Patch Status")}
                  >
                    {patchStatus.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: "hsl(var(--card))", 
                      border: "1px solid hsl(var(--border))",
                      borderRadius: "8px"
                    }} 
                  />
                </PieChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        <div className="grid gap-4 md:grid-cols-2">
          <Card className="animate-fade-in">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <TrendingUp className="h-5 w-5 text-primary" />
                CVE Discovery Trends
              </CardTitle>
              <CardDescription>New vulnerabilities by severity over time</CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={cveTrends}>
                  <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                  <XAxis dataKey="month" stroke="hsl(var(--muted-foreground))" />
                  <YAxis stroke="hsl(var(--muted-foreground))" />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: "hsl(var(--card))", 
                      border: "1px solid hsl(var(--border))",
                      borderRadius: "8px"
                    }} 
                  />
                  <Legend />
                  <Area 
                    type="monotone" 
                    dataKey="critical" 
                    stackId="1"
                    stroke="hsl(var(--destructive))" 
                    fill="hsl(var(--destructive))"
                    fillOpacity={0.6}
                  />
                  <Area 
                    type="monotone" 
                    dataKey="high" 
                    stackId="1"
                    stroke="hsl(48, 96%, 53%)" 
                    fill="hsl(48, 96%, 53%)"
                    fillOpacity={0.6}
                  />
                  <Area 
                    type="monotone" 
                    dataKey="medium" 
                    stackId="1"
                    stroke="hsl(var(--primary))" 
                    fill="hsl(var(--primary))"
                    fillOpacity={0.6}
                  />
                  <Area 
                    type="monotone" 
                    dataKey="low" 
                    stackId="1"
                    stroke="hsl(var(--accent))" 
                    fill="hsl(var(--accent))"
                    fillOpacity={0.6}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>

          <Card className="animate-fade-in">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Clock className="h-5 w-5 text-accent" />
                Remediation Timeline
              </CardTitle>
              <CardDescription>Outstanding vulnerabilities by age</CardDescription>
            </CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={remediationTimeline}>
                  <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                  <XAxis dataKey="week" stroke="hsl(var(--muted-foreground))" />
                  <YAxis stroke="hsl(var(--muted-foreground))" />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: "hsl(var(--card))", 
                      border: "1px solid hsl(var(--border))",
                      borderRadius: "8px"
                    }} 
                  />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="critical" 
                    stroke="hsl(var(--destructive))" 
                    strokeWidth={2}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="high" 
                    stroke="hsl(48, 96%, 53%)" 
                    strokeWidth={2}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="medium" 
                    stroke="hsl(var(--primary))" 
                    strokeWidth={2}
                  />
                </LineChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        </div>

        <Card className="animate-fade-in">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Bug className="h-5 w-5 text-destructive" />
              Exploit Availability Analysis
            </CardTitle>
            <CardDescription>Known exploits and proof-of-concept distribution</CardDescription>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={250}>
              <BarChart data={exploitAvailability} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                <XAxis type="number" stroke="hsl(var(--muted-foreground))" />
                <YAxis dataKey="category" type="category" stroke="hsl(var(--muted-foreground))" width={150} />
                <Tooltip 
                  contentStyle={{ 
                    backgroundColor: "hsl(var(--card))", 
                    border: "1px solid hsl(var(--border))",
                    borderRadius: "8px"
                  }} 
                />
                <Bar 
                  dataKey="count" 
                  onClick={(data) => handleChartClick(data, "Exploit Availability")}
                  cursor="pointer"
                >
                  {exploitAvailability.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>

        <Card className="animate-fade-in">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-destructive" />
              Active Vulnerabilities
            </CardTitle>
            <CardDescription>
              Detailed CVE tracking with patch status and remediation timelines
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {filteredVulnerabilities.map((vuln) => (
                <div
                  key={vuln.id}
                  className="border border-border rounded-lg p-4 hover:bg-accent/5 transition-colors"
                >
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h4 className="font-semibold text-lg">{vuln.title}</h4>
                        <Badge variant={getSeverityBadgeVariant(vuln.severity)}>
                          {vuln.severity.toUpperCase()}
                        </Badge>
                        <Badge variant={getPatchStatusBadgeVariant(vuln.patchStatus)}>
                          {getPatchStatusLabel(vuln.patchStatus)}
                        </Badge>
                        {vuln.exploitAvailable && (
                          <Badge variant="destructive">EXPLOIT AVAILABLE</Badge>
                        )}
                      </div>
                      <div className="flex items-center gap-4 text-sm text-muted-foreground mb-2">
                        <span className="font-mono">{vuln.id}</span>
                        <span>•</span>
                        <span>{vuln.vendor}</span>
                        <span>•</span>
                        <span>Affected Systems: {vuln.affectedSystems}</span>
                        <span>•</span>
                        <span>Discovered: {vuln.discovered}</span>
                      </div>
                    </div>
                    <div className="text-right">
                      <div 
                        className="text-2xl font-bold mb-1" 
                        style={{ color: getSeverityColor(vuln.severity) }}
                      >
                        {vuln.cvss}
                      </div>
                      <div className="text-xs text-muted-foreground">CVSS Score</div>
                    </div>
                  </div>

                  <p className="text-sm text-muted-foreground mb-3">{vuln.description}</p>

                  <div className="bg-muted/50 rounded-md p-3 mb-3">
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <span className="text-muted-foreground">Affected Versions:</span>{" "}
                        <span className="font-medium">{vuln.affectedVersions}</span>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Patch Released:</span>{" "}
                        <span className="font-medium">{vuln.patchReleased || "N/A"}</span>
                      </div>
                    </div>
                  </div>

                  {vuln.daysToRemediate > 0 && (
                    <div className="mb-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium">Remediation Progress</span>
                        <span className="text-sm text-muted-foreground">
                          {vuln.daysToRemediate} days remaining
                        </span>
                      </div>
                      <Progress 
                        value={Math.max(0, 100 - (vuln.daysToRemediate / 30) * 100)} 
                        className="h-2" 
                      />
                    </div>
                  )}

                  <div className="flex items-center justify-between pt-2 border-t border-border">
                    <div className="text-sm">
                      <span className="text-muted-foreground">Deadline:</span>{" "}
                      <span className="font-semibold">{vuln.remediationDeadline}</span>
                    </div>
                    <a 
                      href={`https://nvd.nist.gov/vuln/detail/${vuln.id}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-sm text-primary hover:underline flex items-center gap-1"
                    >
                      View NVD Details
                      <ExternalLink className="h-3 w-3" />
                    </a>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        <DrillDownModal
          open={isModalOpen}
          onOpenChange={setIsModalOpen}
          data={drillDownData}
        />
      </div>
    </DashboardLayout>
  );
};

export default VulnerabilityManagement;
